<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Job Search</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .mic-btn {
            position: absolute;
            right: 12px;
            bottom: 12px;
            border: none;
            background: transparent;
            color: #0d6efd;
            font-size: 1.3rem;
            cursor: pointer;
        }
        .mic-btn.recording {
            color: red;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="#"><i class="bi bi-lightbulb me-2 text-primary"></i> PATHFINDER</a>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
                <li class="nav-item"><a class="nav-link" href="#">Profile</a></li>
                <li class="nav-item"><a class="nav-link" href="#">Logout</a></li>
            </ul>
        </div>
    </div>
</nav>

<div class="container py-5">
    <h2 class="text-center fw-bold text-primary mb-4"><i class="fas fa-search"></i> Job Search</h2>

    <!-- ✅ Show error message if FastAPI passes one -->
    {% if error %}
    <div class="alert alert-danger text-center">
        {{ error }}
    </div>
    {% endif %}

    <!-- ✅ Changed action from Flask's url_for() to FastAPI route -->
    <form method="POST" action="/search" class="bg-white p-4 shadow rounded">

        <!-- Job Description with Mic -->
        <div class="mb-3 position-relative">
            <label for="description" class="form-label">Job Description</label>
            <textarea class="form-control" id="description" name="description" rows="3" required></textarea>
            <button type="button" id="micBtn" class="mic-btn">
                <i class="fas fa-microphone"></i>
            </button>
        </div>

        <!-- Country -->
        <div class="mb-3">
            <label for="country" class="form-label">Country</label>
            <select class="form-select" id="country" name="country" required>
                <option value="">Select Country</option>
            </select>
        </div>

        <!-- State -->
        <div class="mb-3">
            <label for="state" class="form-label">State</label>
            <select class="form-select" id="state" name="state" required>
                <option value="">Select State</option>
            </select>
        </div>

        <!-- City -->
        <div class="mb-3">
            <label for="city" class="form-label">City</label>
            <select class="form-select" id="city" name="city" required>
                <option value="">Select City</option>
            </select>
        </div>

        <!-- Date Posted -->
        <div class="mb-3">
            <label for="date_posted" class="form-label">Date Posted</label>
            <select class="form-select" id="date_posted" name="date_posted">
                <option value="all" selected>All</option>
                <option value="today">Past 24 hours</option>
                <option value="week">Past week</option>
                <option value="month">Past month</option>
            </select>
        </div>

        <!-- Submit -->
        <div class="text-center">
            <button type="submit" class="btn btn-primary px-4"><i class="fas fa-search"></i> Search</button>
        </div>
    </form>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  let locationData = null;
  const countrySelect = document.getElementById("country");
  const stateSelect = document.getElementById("state");
  const citySelect = document.getElementById("city");

  // ✅ Changed Flask's url_for to FastAPI static path
  fetch("/static/data/locations.json")
    .then(res => res.json())
    .then(data => {
      locationData = data.length ? data : [data];
      locationData.forEach(country => {
        let opt = document.createElement("option");
        opt.value = country.name;
        opt.textContent = country.name;
        countrySelect.appendChild(opt);
      });
    });

  // Country → States
  countrySelect.addEventListener("change", () => {
    stateSelect.innerHTML = "<option value=''>Select State</option>";
    citySelect.innerHTML = "<option value=''>Select City</option>";
    let selectedCountry = locationData.find(c => c.name === countrySelect.value);
    if (selectedCountry) {
      selectedCountry.states.forEach(state => {
        let opt = document.createElement("option");
        opt.value = state.name;
        opt.textContent = state.name;
        stateSelect.appendChild(opt);
      });
    }
  });

  // State → Cities
  stateSelect.addEventListener("change", () => {
    citySelect.innerHTML = "<option value=''>Select City</option>";
    let selectedCountry = locationData.find(c => c.name === countrySelect.value);
    if (selectedCountry) {
      let selectedState = selectedCountry.states.find(s => s.name === stateSelect.value);
      if (selectedState) {
        selectedState.cities.forEach(city => {
          let opt = document.createElement("option");
          opt.value = city.name;
          opt.textContent = city.name;
          citySelect.appendChild(opt);
        });
      }
    }
  });

  // 🎙️ Mic Speech-to-text
  const micBtn = document.getElementById("micBtn");
  const descriptionBox = document.getElementById("description");
  let recognition;
  if ("webkitSpeechRecognition" in window) {
    recognition = new webkitSpeechRecognition();
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.lang = "en-US";

    micBtn.addEventListener("click", () => {
      if (micBtn.classList.contains("recording")) {
        recognition.stop();
        micBtn.classList.remove("recording");
      } else {
        recognition.start();
        micBtn.classList.add("recording");
      }
    });

    recognition.onresult = (event) => {
      descriptionBox.value += (descriptionBox.value ? " " : "") + event.results[0][0].transcript;
    };

    recognition.onend = () => {
      micBtn.classList.remove("recording");
    };
  } else {
    micBtn.style.display = "none";
  }
</script>
</body>
</html>
